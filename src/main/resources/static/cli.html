<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Vendo-Matic 800 Â· CLI</title>
    <style>
        /* simple terminal style */
        :root{--bg:#0b0f14;--panel:#0f1720;--fg:#e6edf3;--dim:#9fb0c0}
        body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 ui-monospace,Menlo,Consolas,monospace}
        .wrap{max-width:920px;margin:28px auto;padding:16px}
        .term{border:1px solid #1f2937;background:var(--panel);border-radius:12px;padding:14px;min-height:60vh;max-height:70vh;overflow-y:auto}
        .out{white-space:pre-wrap}
        .prompt{display:flex;gap:8px;margin-top:12px}
        input{flex:1;padding:10px;border-radius:8px;border:1px solid #334155;background:#111827;color:var(--fg)}
    </style>
</head>
<body>
<div class="wrap">
    <div id="term" class="term">
        <div id="out" class="out"></div>
    </div>
    <div class="prompt">
        <input id="cmd" placeholder="Type: 1 | 2 | 3 | 4 | feed 2 | select A1 | finish | help"/>
    </div>
</div>

<script>
    const term = document.getElementById('term');
    const out  = document.getElementById('out');
    const cmd  = document.getElementById('cmd');

    function autoScroll(){
      term.scrollTop = term.scrollHeight;
      out.scrollTop  = out.scrollHeight;
    }

    function printBlock(txt){
      // show raw text
      const d = document.createElement('div');
      d.textContent = txt;
      out.appendChild(d);

      // if server mentions report, append a clickable link
      if (/download sales report/i.test(txt)) {
        const linkWrap = document.createElement('div');
        const a = document.createElement('a');
        a.href = '/cli/report';
        a.textContent = 'Click here to download report.txt';
        a.style.display = 'inline-block';
        a.style.marginTop = '6px';
        linkWrap.appendChild(a);
        out.appendChild(linkWrap);

        // try auto download once (some browsers require gesture, but we try anyway)
        a.download = '';
        setTimeout(() => a.click(), 100);
      }

      autoScroll();
    }

    // real download helper if user types "report"
    function download(url){
      const a = document.createElement('a');
      a.href = url;
      a.download = '';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function send(line){
      const t = line.trim();

      // manual command to force download
      if (t.toLowerCase() === 'report') {
        printBlock('Downloading sales report...');
        download('/cli/report');
        return;
      }

      const res = await fetch('/cli', {
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body: line
      });
      const txt = await res.text();
      printBlock(txt);

      // fallback: if text contains the path anywhere, also trigger download
      if (txt.includes('/cli/report')) {
        download('/cli/report');
      }
    }

    cmd.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const t = cmd.value.trim();
        if(t){
          // echo user's input (no $ prefix)
          const echo = document.createElement('div');
          echo.textContent = t;
          out.appendChild(echo);
          autoScroll();

          send(t);
        }
        cmd.value='';
      }
    });

    // show main menu on load
    send('menu');
    cmd.focus();
</script>
</body>
</html>